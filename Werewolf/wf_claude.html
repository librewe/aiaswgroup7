<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤šæ™ºèƒ½ä½“ç‹¼äººæ€</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        .game-header {
            text-align: center;
            margin-bottom: 30px;
        }
        .game-title {
            color: #333;
            margin-bottom: 15px;
            font-size: 2rem;
        }
        .game-status {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
            flex-wrap: wrap;
        }
        .phase-indicator {
            display: flex;
            gap: 10px;
        }
        .phase-step {
            padding: 8px 16px;
            border-radius: 20px;
            background: #f0f0f0;
            color: #666;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        .phase-step.active {
            background: #667eea;
            color: white;
        }
        #game-phase {
            font-size: 1.2rem;
            font-weight: bold;
            color: #333;
        }
        #game-round {
            font-size: 1rem;
            color: #666;
        }
        .players-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        .player-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }
        .player-card.user {
            border-color: #667eea;
        }
        .player-card.ai {
            border-color: #95a5a6;
        }
        .player-card.dead {
            opacity: 0.6;
            background: #f8f8f8;
        }
        .player-name {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
        }
        .player-role {
            font-size: 0.9rem;
            margin-bottom: 8px;
            color: #666;
        }
        .player-status {
            font-size: 0.8rem;
        }
        .game-log {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            height: 300px;
            overflow-y: auto;
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
        }
        .log-entry {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 0.9rem;
            line-height: 1.4;
        }
        .log-entry.system {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
        }
        .log-entry.player {
            background: #f3e5f5;
            border-left: 4px solid #9c27b0;
        }
        .log-entry.werewolf {
            background: #ffebee;
            border-left: 4px solid #f44336;
        }
        .action-panel {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            min-width: 80px;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn.primary {
            background: #667eea;
            color: white;
        }
        .btn.primary:hover:not(:disabled) {
            background: #5a6fd8;
        }
        .btn.danger {
            background: #e74c3c;
            color: white;
        }
        .btn.danger:hover:not(:disabled) {
            background: #d63031;
        }
        .btn:not(.primary):not(.danger) {
            background: #95a5a6;
            color: white;
        }
        .btn:not(.primary):not(.danger):hover:not(:disabled) {
            background: #7f8c8d;
        }
        #action-status {
            color: #666;
            font-style: italic;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }
        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        .modal-content h3 {
            margin-bottom: 15px;
            color: #333;
        }
        .input-group {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        .input-group input,
        .input-group select {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.9rem;
        }
        .loading {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .phase-timer {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="game-header">
            <h1 class="game-title">ğŸº å¤šæ™ºèƒ½ä½“ç‹¼äººæ€ (å¤œæ™šèµ·å§‹ç‰ˆ)</h1>
            <div class="game-status">
                <div class="phase-indicator">
                    <div class="phase-step" id="phase-night">å¤œæ™š</div>
                    <div class="phase-step" id="phase-day">ç™½å¤©</div>
                    <div class="phase-step" id="phase-vote">æŠ•ç¥¨</div>
                </div>
                <div id="game-phase">æ¸¸æˆå‡†å¤‡ä¸­...</div>
                <div id="game-round">ç¬¬ 0 å›åˆ</div>
            </div>
        </div>
        <div class="players-grid" id="players-grid">
            <!-- ç©å®¶å¡ç‰‡å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
        </div>
        <div class="game-log" id="game-log">
            <!-- æ¸¸æˆæ—¥å¿—å°†é€šè¿‡è„šæœ¬åŠ¨æ€ç”Ÿæˆ -->
        </div>
        <div class="action-panel">
            <div class="action-buttons">
                <button class="btn primary" id="start-game">å¼€å§‹æ¸¸æˆ</button>
                <button class="btn" id="speak-btn" disabled>å‘è¨€</button>
                <button class="btn" id="vote-btn" disabled>æŠ•ç¥¨</button>
                <button class="btn danger" id="kill-btn" disabled>å‡»æ€</button>
                <!-- å®ˆæŠ¤æŒ‰é’®å·²ç§»é™¤ï¼Œå› å½“å‰ç‰ˆæœ¬ä¸å«å®ˆå«è§’è‰² -->
                <button class="btn" id="predict-btn" disabled>é¢„è¨€</button>
                <button class="btn" id="save-btn" disabled>æ•‘äºº</button>
                <button class="btn danger" id="poison-btn" disabled>æ¯’äºº</button>
                <button class="btn" id="skip-witch-btn" disabled>è·³è¿‡å¥³å·«è¡ŒåŠ¨</button>
                <button class="btn" id="api-test-btn">æµ‹è¯•APIè¿æ¥</button>
            </div>
            <div id="action-status">ç­‰å¾…æ¸¸æˆå¼€å§‹...</div>
        </div>
    </div>
    
    <!-- æ¨¡æ€æ¡† -->
    <div class="modal" id="speak-modal">
        <div class="modal-content">
            <h3>å‘è¨€</h3>
            <div class="input-group">
                <input type="text" id="speak-input" placeholder="è¾“å…¥ä½ çš„å‘è¨€å†…å®¹...">
                <button class="btn primary" onclick="speak()">å‘è¨€</button>
                <button class="btn" onclick="closeModal('speak-modal')">å–æ¶ˆ</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="vote-modal">
        <div class="modal-content">
            <h3>æŠ•ç¥¨å‡ºå±€</h3>
            <div class="input-group">
                <select id="vote-select">
                    <option value="">é€‰æ‹©è¦æŠ•ç¥¨çš„ç©å®¶</option>
                </select>
                <button class="btn primary" onclick="vote()">æŠ•ç¥¨</button>
                <button class="btn" onclick="closeModal('vote-modal')">å–æ¶ˆ</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="kill-modal">
        <div class="modal-content">
            <h3>ç‹¼äººå‡»æ€</h3>
            <div class="input-group">
                <select id="kill-select">
                    <option value="">é€‰æ‹©è¦å‡»æ€çš„ç©å®¶</option>
                </select>
                <button class="btn danger" onclick="kill()">å‡»æ€</button>
                <button class="btn" onclick="closeModal('kill-modal')">å–æ¶ˆ</button>
            </div>
        </div>
    </div>
    
    <!-- å®ˆæŠ¤æ¨¡æ€æ¡†å·²ç§»é™¤ -->
    
    <div class="modal" id="predict-modal">
        <div class="modal-content">
            <h3>é¢„è¨€å®¶æŸ¥éªŒ</h3>
            <div class="input-group">
                <select id="predict-select">
                    <option value="">é€‰æ‹©è¦æŸ¥éªŒçš„ç©å®¶</option>
                </select>
                <button class="btn primary" onclick="predict()">æŸ¥éªŒ</button>
                <button class="btn" onclick="closeModal('predict-modal')">å–æ¶ˆ</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="poison-modal">
        <div class="modal-content">
            <h3>å¥³å·«æ¯’äºº</h3>
            <p>è¯·é€‰æ‹©è¦æ¯’æ€çš„ç©å®¶ï¼ˆæˆ–é€‰æ‹©ä¸ä½¿ç”¨æ¯’è¯ï¼‰ã€‚</p>
            <div class="input-group">
                <select id="poison-select">
                    <option value="">é€‰æ‹©è¦æ¯’æ€çš„ç©å®¶</option>
                </select>
                <button class="btn danger" onclick="poison()">ä½¿ç”¨æ¯’è¯</button>
                <button class="btn" onclick="skipPoison()">ä¸ä½¿ç”¨æ¯’è¯</button>
            </div>
        </div>
    </div>
    
    <!-- APIè®¾ç½®æ¨¡æ€æ¡† -->
    <div class="modal" id="api-settings-modal">
        <div class="modal-content">
            <h3>APIè®¾ç½®</h3>
            <div class="input-group">
                <input type="text" id="api-url-input" placeholder="APIåœ°å€ (å¦‚: http://localhost:10021)">
            </div>
            <div class="input-group">
                <button class="btn primary" onclick="saveApiSettings()">ä¿å­˜</button>
                <button class="btn" onclick="closeModal('api-settings-modal')">å–æ¶ˆ</button>
            </div>
        </div>
    </div>
    
    <div id="phase-timer" class="phase-timer"></div>
    
    <script>
        // æ¸¸æˆçŠ¶æ€
        const gameState = {
            players: [],
            currentPhase: 'waiting', // 'waiting', 'night', 'day', 'vote', 'ended'
            currentRound: 0,
            userPlayer: null,
            votes: {},
            actions: {}, // ç”¨äºå¤œæ™šè¡ŒåŠ¨
            gameLog: [],
            apiUrl: 'http://localhost:10021',
            timers: [], // å­˜å‚¨æ´»åŠ¨å®šæ—¶å™¨ID
            spokenPlayers: new Set(), // è®°å½•å·²å‘è¨€çš„ç©å®¶IDï¼Œé¿å…é‡å¤å‘è¨€
            aiActionInProgress: false, // æ ‡è®°AIæ“ä½œæ˜¯å¦æ­£åœ¨è¿›è¡Œ
            // è®°å½•å¥³å·«çŠ¶æ€
            witchState: {
                antidoteUsed: false, // è§£è¯æ˜¯å¦å·²ä½¿ç”¨
                poisonUsed: false,    // æ¯’è¯æ˜¯å¦å·²ä½¿ç”¨
                lastKilledPlayerId: null, // ä¸Šä¸€æ™šè¢«ç‹¼äººå‡»æ€çš„ç©å®¶ID
                userActionCompleted: false, // ç”¨æˆ·å¥³å·«æ˜¯å¦å·²å®Œæˆè¡ŒåŠ¨ï¼ˆä¸‰é€‰ä¸€ï¼‰
            },
            // æ¯ä¸ªç©å®¶çš„å«Œç–‘å€¼ï¼Œç”¨äºAIæŠ•ç¥¨å†³ç­–
            suspicion: {},
            // é¢„è¨€å®¶å·²ç»æŸ¥éªŒè¿‡çš„ç©å®¶IDåˆ—è¡¨ï¼Œç”¨äºé¿å…é‡å¤æŸ¥éªŒ
            seerMemory: [],
            // æ ‡è®°AIå‘è¨€åºåˆ—æ˜¯å¦æ­£åœ¨è¿›è¡Œï¼Œé˜²æ­¢é‡å¤è§¦å‘
            aiSpeaking: false,
        };

        // åˆå§‹åŒ–æ¸¸æˆ
        function initGame() {
            // é‡ç½®çŠ¶æ€
            gameState.players = [];
            gameState.currentPhase = 'waiting';
            gameState.currentRound = 0;
            gameState.votes = {};
            gameState.actions = {};
            gameState.gameLog = [];
            gameState.spokenPlayers.clear();
            gameState.aiActionInProgress = false;
            // é‡ç½®å«Œç–‘å€¼ã€é¢„è¨€å®¶è®°å¿†å’ŒAIå‘è¨€çŠ¶æ€
            gameState.suspicion = {};
            gameState.seerMemory = [];
            gameState.aiSpeaking = false;
            clearAllTimers();
            gameState.witchState.antidoteUsed = false;
            gameState.witchState.poisonUsed = false;
            gameState.witchState.lastKilledPlayerId = null;
            gameState.witchState.userActionCompleted = false;

            // åˆ›å»ºç©å®¶ï¼ˆ1ä¸ªç”¨æˆ·ï¼Œ7ä¸ªAIï¼‰
            for (let i = 0; i < 8; i++) {
                gameState.players.push({
                    id: i,
                    name: i === 0 ? 'ä½ ' : `AIç©å®¶${i}`,
                    type: i === 0 ? 'user' : 'ai',
                    role: '', // å¾…åˆ†é…
                    alive: true,
                    votedBy: []
                });
                // åˆå§‹åŒ–æ¯ä¸ªç©å®¶çš„å«Œç–‘å€¼
                gameState.suspicion[i] = 0;
            }
            gameState.userPlayer = gameState.players[0];
            renderPlayers();
            updateGameStatus();
            updateButtons();
            addLog('ç³»ç»Ÿ', 'ğŸ® æ¬¢è¿æ¥åˆ°ç‹¼äººæ€æ¸¸æˆï¼ç‚¹å‡»"å¼€å§‹æ¸¸æˆ"å¼€å§‹æ–°çš„ä¸€å±€ã€‚', 'system');
        }

        // å¼€å§‹æ¸¸æˆ
        async function startGame() {
            // é‡ç½®æ¸¸æˆçŠ¶æ€
            gameState.currentPhase = 'night';
            gameState.currentRound = 1;
            gameState.votes = {};
            gameState.actions = {};
            gameState.spokenPlayers.clear();
            gameState.aiActionInProgress = false;
            // é‡ç½®å«Œç–‘å€¼ã€é¢„è¨€å®¶è®°å¿†å’ŒAIå‘è¨€çŠ¶æ€
            gameState.suspicion = {};
            gameState.seerMemory = [];
            gameState.aiSpeaking = false;
            clearAllTimers();
            gameState.witchState.antidoteUsed = false;
            gameState.witchState.poisonUsed = false;
            gameState.witchState.lastKilledPlayerId = null;
            gameState.witchState.userActionCompleted = false;

            // é‡ç½®æ‰€æœ‰ç©å®¶çŠ¶æ€
            gameState.players.forEach(player => {
                player.alive = true;
                player.votedBy = [];
                player.role = '';
                // æ¯ä¸ªç©å®¶å«Œç–‘å€¼é‡ç½®ä¸º0
                gameState.suspicion[player.id] = 0;
            });
            assignRoles();
            addLog('ç³»ç»Ÿ', 'ğŸ® æ¸¸æˆå¼€å§‹ï¼èº«ä»½å·²åˆ†é…å®Œæˆã€‚', 'system');
            addLog('ç³»ç»Ÿ', `ä½ çš„èº«ä»½æ˜¯ï¼š${getRoleName(gameState.userPlayer.role)}`, 'system');
            // å¦‚æœä½ æ˜¯ç‹¼äººï¼Œå‘ŠçŸ¥ä½ çš„ç‹¼é˜Ÿå‹
            if (gameState.userPlayer.role === 'werewolf') {
                const teammates = gameState.players.filter(p => p.role === 'werewolf' && p.id !== gameState.userPlayer.id);
                if (teammates.length > 0) {
                    const names = teammates.map(t => t.name).join('ã€');
                    addLog('ç³»ç»Ÿ', `ä½ çš„ç‹¼é˜Ÿå‹æ˜¯ï¼š${names}`, 'system');
                } else {
                    addLog('ç³»ç»Ÿ', 'ä½ æ˜¯å”¯ä¸€çš„ç‹¼äººï¼Œè¯·å°å¿ƒè¡Œäº‹ï¼', 'system');
                }
            }
            updateGameStatus();
            updateButtons();
            renderPlayers();

            // å¼€å§‹ç¬¬ä¸€å¤œ
            setTimeout(() => {
                addLog('æ³•å®˜', `ğŸŒ™ ç¬¬${gameState.currentRound}å¤œï¼Œå¤œå¹•é™ä¸´ï¼Œæ‰€æœ‰ç©å®¶è¯·é—­çœ¼ã€‚`, 'system');
                startNightPhase();
            }, 2000);
        }

        // åˆ†é…èº«ä»½
        function assignRoles() {
            const roles = ['werewolf', 'werewolf', 'seer', 'witch', 'villager', 'villager', 'villager', 'villager'];
            const shuffledRoles = shuffleArray([...roles]);
            gameState.players.forEach((player, index) => {
                player.role = shuffledRoles[index];
            });
            gameState.userPlayer = gameState.players[0];
        }

        // æ´—ç‰Œç®—æ³•
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // è·å–èº«ä»½åç§°
        function getRoleName(role) {
            const roleNames = {
                'werewolf': 'ğŸº ç‹¼äºº',
                'seer': 'ğŸ”® é¢„è¨€å®¶',
                'witch': 'ğŸ§ª å¥³å·«',
                'villager': 'ğŸ‘¨â€ğŸŒ¾ å¹³æ°‘'
            };
            return roleNames[role] || 'æœªçŸ¥';
        }

        // å¤œæ™šé˜¶æ®µ
        function startNightPhase() {
            if (gameState.currentPhase === 'ended') return;
            gameState.currentPhase = 'night';
            gameState.actions = {};
            gameState.witchState.userActionCompleted = false; // é‡ç½®ç”¨æˆ·å¥³å·«è¡ŒåŠ¨çŠ¶æ€
            updateGameStatus();
            updateButtons();
            addLog('æ³•å®˜', 'ğŸŒ™ å¤œå¹•é™ä¸´ï¼Œæ‰€æœ‰ç©å®¶è¯·é—­çœ¼ã€‚', 'system');

            // å¡«å……è¡ŒåŠ¨é€‰æ‹©
            fillActionSelects();

            // AIè¡ŒåŠ¨
            setTimeout(() => aiNightActions(), 2000);
        }

        // å¡«å……è¡ŒåŠ¨é€‰æ‹©ä¸‹æ‹‰æ¡†
        function fillActionSelects() {
            const killSelect = document.getElementById('kill-select');
            const predictSelect = document.getElementById('predict-select');
            const poisonSelect = document.getElementById('poison-select');
            
            killSelect.innerHTML = '<option value="">é€‰æ‹©è¦å‡»æ€çš„ç©å®¶</option>';
            predictSelect.innerHTML = '<option value="">é€‰æ‹©è¦æŸ¥éªŒçš„ç©å®¶</option>';
            poisonSelect.innerHTML = '<option value="">é€‰æ‹©è¦æ¯’æ€çš„ç©å®¶</option>';

            const alivePlayers = gameState.players.filter(p => p.alive && p.id !== gameState.userPlayer.id);
            alivePlayers.forEach(player => {
                const option1 = document.createElement('option');
                option1.value = player.id;
                option1.textContent = player.name;
                killSelect.appendChild(option1.cloneNode(true));

                const option2 = document.createElement('option');
                option2.value = player.id;
                option2.textContent = player.name;
                predictSelect.appendChild(option2.cloneNode(true));

                const option3 = document.createElement('option');
                option3.value = player.id;
                option3.textContent = player.name;
                poisonSelect.appendChild(option3.cloneNode(true));
            });
        }

        // AIå¤œæ™šè¡ŒåŠ¨
        async function aiNightActions() {
            if (gameState.currentPhase !== 'night') return;
            gameState.aiActionInProgress = true;
            addLog('ç³»ç»Ÿ', 'ğŸ¤– AIæ­£åœ¨æ‰§è¡Œå¤œæ™šè¡ŒåŠ¨...', 'system');

            // ------------------------ ç‹¼äººè¡ŒåŠ¨ ------------------------
            // å¦‚æœç”¨æˆ·ä¸æ˜¯ç‹¼äººï¼Œåˆ™ç”±AIç‹¼äººé›†ä½“é€‰æ‹©å‡»æ€ç›®æ ‡ï¼›å¦åˆ™ç­‰å¾…ç”¨æˆ·å†³ç­–
            const userIsWerewolf = isUserWerewolf();
            const aliveAIWolves = gameState.players.filter(p => p.alive && p.role === 'werewolf' && p.type === 'ai');
            if (!userIsWerewolf && aliveAIWolves.length > 0) {
                const candidates = gameState.players.filter(p => p.alive && p.role !== 'werewolf');
                if (candidates.length > 0) {
                    const target = candidates[Math.floor(Math.random() * candidates.length)];
                    gameState.actions.killTarget = target.id;
                    // è®°å½•ç›®æ ‡ä¾›å¥³å·«ä½¿ç”¨è§£è¯
                    gameState.witchState.lastKilledPlayerId = target.id;
                    // ä¸€æ—¦ç‹¼äººå›¢é˜Ÿé€‰æ‹©äº†å‡»æ€ç›®æ ‡ï¼Œæ›´æ–°æŒ‰é’®çŠ¶æ€ï¼Œè®©å¥³å·«èƒ½å¤Ÿçœ‹åˆ°å¯æ•‘äºº
                    updateButtons();
                    // ä¸å‘æ—¥å¿—é€éœ²å…·ä½“å‡»æ€ä¿¡æ¯ï¼Œä»¥ä¿æŒå¤œé—´ä¿¡æ¯éšè”½
                }
            }

            // ------------------------ é¢„è¨€å®¶è¡ŒåŠ¨ ------------------------
            // AIé¢„è¨€å®¶æŸ¥éªŒæ²¡æœ‰æŸ¥éªŒè¿‡çš„ç©å®¶ï¼Œæ›´æ–°å«Œç–‘å€¼ä½†ä¸å¹¿æ’­ç»“æœ
            const seer = gameState.players.find(p => p.alive && p.role === 'seer' && p.type === 'ai');
            if (seer) {
                // æ‰¾åˆ°æœªæŸ¥éªŒçš„å­˜æ´»ç©å®¶
                const untested = gameState.players.filter(p => p.alive && p.id !== seer.id && !gameState.seerMemory.includes(p.id));
                const candidates = untested.length > 0 ? untested : gameState.players.filter(p => p.alive && p.id !== seer.id);
                if (candidates.length > 0) {
                    const target = candidates[Math.floor(Math.random() * candidates.length)];
                    gameState.actions.seerTarget = target.id;
                    // è®°å½•æŸ¥éªŒå†å²
                    gameState.seerMemory.push(target.id);
                    const isWolf = target.role === 'werewolf';
                    // æ›´æ–°å«Œç–‘å€¼ï¼šæŸ¥éªŒç‹¼äººåˆ™æé«˜å«Œç–‘ï¼ŒæŸ¥éªŒå¥½äººåˆ™é™ä½å«Œç–‘
                    if (gameState.suspicion[target.id] === undefined) gameState.suspicion[target.id] = 0;
                    gameState.suspicion[target.id] += isWolf ? 10 : -3;
                    // é™åˆ¶å«Œç–‘å€¼èŒƒå›´ï¼Œé¿å…æç«¯
                    if (gameState.suspicion[target.id] < -10) gameState.suspicion[target.id] = -10;
                }
            }

            // ------------------------ å¥³å·«è¡ŒåŠ¨ ------------------------
            // AIå¥³å·«åªèƒ½åœ¨è§£è¯ä¸æ¯’è¯ä¹‹é—´é€‰æ‹©å…¶ä¸€ï¼Œä¸ä¼šåŒæ—¶ä½¿ç”¨
            const witch = gameState.players.find(p => p.alive && p.role === 'witch' && p.type === 'ai');
            if (witch) {
                const hasAntidote = !gameState.witchState.antidoteUsed;
                const hasPoison = !gameState.witchState.poisonUsed;
                let usedAntidote = false;
                // å¦‚æœç‹¼äººçš„å‡»æ€ç›®æ ‡å­˜åœ¨ï¼Œåˆ™50%æ¦‚ç‡ä½¿ç”¨è§£è¯
                if (hasAntidote && (gameState.actions.killTarget !== undefined)) {
                    if (Math.random() > 0.5) {
                        gameState.actions.witchSave = gameState.actions.killTarget;
                        gameState.witchState.antidoteUsed = true;
                        usedAntidote = true;
                    }
                }
                // å¦‚æœæ²¡æœ‰ä½¿ç”¨è§£è¯ï¼Œè€ƒè™‘ä½¿ç”¨æ¯’è¯
                if (!usedAntidote && hasPoison) {
                    // 30%æ¦‚ç‡å‘åŠ¨æ¯’è¯
                    if (Math.random() > 0.7) {
                        // å¯æ¯’æ€çš„ç›®æ ‡ä¸ºå­˜æ´»ç©å®¶ä¸­æ’é™¤è‡ªå·±å’Œå‡»æ€ç›®æ ‡
                        const poisonCandidates = gameState.players.filter(p => p.alive && p.id !== witch.id && p.id !== gameState.actions.killTarget);
                        if (poisonCandidates.length > 0) {
                            const target = poisonCandidates[Math.floor(Math.random() * poisonCandidates.length)];
                            gameState.actions.witchPoison = target.id;
                            gameState.witchState.poisonUsed = true;
                        }
                    }
                }
            }

            gameState.aiActionInProgress = false;

            // ç­‰å¾…ç”¨æˆ·å®Œæˆæ“ä½œæˆ–3ç§’åå¤„ç†ç»“æœ
            setTimeout(() => {
                checkAndProceedNight();
            }, 3000);
        }

        // æ£€æŸ¥å¹¶æ¨è¿›å¤œæ™šæµç¨‹
        function checkAndProceedNight() {
            if (gameState.currentPhase !== 'night') return;

            // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦éœ€è¦å®Œæˆå¤œæ™šè¡ŒåŠ¨
            const userNeedsAction = (
                (isUserWerewolf() && !gameState.actions.userKillTarget) ||
                (isUserSeer() && !gameState.actions.userSeerTarget) ||
                (isUserWitch() && !gameState.witchState.userActionCompleted)
            );

            if (userNeedsAction && !gameState.aiActionInProgress) {
                addLog('ç³»ç»Ÿ', 'â³ ç­‰å¾…ç”¨æˆ·å®Œæˆå¤œæ™šè¡ŒåŠ¨...', 'system');
                return;
            }

            // å¦‚æœAIè¿˜åœ¨è¡ŒåŠ¨ä¸­ï¼Œç­‰å¾…
            if (gameState.aiActionInProgress) {
                addLog('ç³»ç»Ÿ', 'â³ ç­‰å¾…AIå®Œæˆå¤œæ™šè¡ŒåŠ¨...', 'system');
                setTimeout(() => checkAndProceedNight(), 1000);
                return;
            }

            // æ‰€æœ‰è¡ŒåŠ¨å®Œæˆï¼Œå¤„ç†å¤œæ™šç»“æœ
            processNightResult();
        }

        // å¤„ç†å¤œæ™šç»“æœ
        function processNightResult() {
            addLog('æ³•å®˜', 'â˜€ï¸ å¤©äº®äº†ï¼', 'system');
            let deaths = [];

            // åˆå¹¶ç”¨æˆ·å’ŒAIçš„è¡ŒåŠ¨
            const killTargetId = gameState.actions.userKillTarget || gameState.actions.killTarget;
            const witchSaveId = gameState.actions.userWitchSave || gameState.actions.witchSave;
            const witchPoisonId = gameState.actions.userWitchPoison || gameState.actions.witchPoison;

            // å¤„ç†æ¯’æ€
            if (witchPoisonId !== undefined) {
                const poisonedPlayer = gameState.players.find(p => p.id === witchPoisonId);
                if (poisonedPlayer && poisonedPlayer.alive) {
                    poisonedPlayer.alive = false;
                    deaths.push(`${poisonedPlayer.name}ï¼ˆ${getRoleName(poisonedPlayer.role)}ï¼‰è¢«æ¯’æ€`);
                }
            }

            // å¤„ç†å‡»æ€ï¼ˆå¦‚æœæœªè¢«æ•‘ï¼‰
            if (killTargetId !== undefined && killTargetId !== witchSaveId) {
                const killedPlayer = gameState.players.find(p => p.id === killTargetId);
                if (killedPlayer && killedPlayer.alive) {
                    killedPlayer.alive = false;
                    gameState.witchState.lastKilledPlayerId = killTargetId;
                    deaths.push(`${killedPlayer.name}ï¼ˆ${getRoleName(killedPlayer.role)}ï¼‰è¢«ç‹¼äººå‡»æ€`);
                }
            } else if (killTargetId !== undefined && killTargetId === witchSaveId) {
                const savedPlayer = gameState.players.find(p => p.id === killTargetId);
                if (savedPlayer) {
                    addLog('æ³•å®˜', `ğŸ›¡ï¸ æ˜¨å¤œ ${savedPlayer.name} è¢«å¥³å·«æ•‘ä¸‹ï¼Œå¹³å®‰æ— äº‹ï¼`, 'system');
                    gameState.witchState.lastKilledPlayerId = killTargetId;
                }
            }

            if (deaths.length > 0) {
                addLog('æ³•å®˜', `ğŸ’€ æ˜¨å¤œå‘ç”Ÿæƒ¨æ¡ˆï¼š${deaths.join('ï¼Œ')}ï¼`, 'system');
            } else if (!(witchSaveId && killTargetId)) {
                addLog('æ³•å®˜', 'ğŸ˜´ æ˜¨å¤œå¹³å®‰æ— äº‹ï¼Œæ²¡æœ‰äººæ­»äº¡ã€‚', 'system');
            }

            renderPlayers();

            // æ£€æŸ¥æ¸¸æˆæ˜¯å¦ç»“æŸ
            if (checkGameEnd()) {
                return;
            }

            // è¿›å…¥ç™½å¤©é˜¶æ®µ
            setTimeout(() => {
                gameState.spokenPlayers.clear();
                startDayPhase();
            }, 3000);
        }

        // ç™½å¤©é˜¶æ®µ
        async function startDayPhase() {
            if (gameState.currentPhase === 'ended') return;
            gameState.currentPhase = 'day';
            gameState.spokenPlayers.clear();
            // é‡ç½®AIå‘è¨€çŠ¶æ€ï¼Œå¼€å§‹æ–°çš„å‘è¨€åºåˆ—
            gameState.aiSpeaking = false;
            updateGameStatus();
            updateButtons();
            addLog('æ³•å®˜', `â˜€ï¸ ç¬¬${gameState.currentRound}å¤©ï¼Œå¤©äº®äº†ï¼Œæ‰€æœ‰ç©å®¶è¯·å¼€å§‹è‡ªç”±è®¨è®ºã€‚`, 'system');

            // å»¶è¿Ÿåå¼€å§‹AIå‘è¨€
            setTimeout(() => {
                aiPlayersSpeakSequence();
            }, 2000);

            // 30ç§’åè‡ªåŠ¨è¿›å…¥æŠ•ç¥¨
            const timeoutId = setTimeout(() => {
                if (gameState.currentPhase === 'day') {
                    addLog('æ³•å®˜', 'â° è®¨è®ºæ—¶é—´åˆ°ï¼Œè¿›å…¥æŠ•ç¥¨é˜¶æ®µã€‚', 'system');
                    startVotePhase();
                }
            }, 30000);
            gameState.timers.push(timeoutId);
        }

        // AIç©å®¶æŒ‰é¡ºåºå‘è¨€
        async function aiPlayersSpeakSequence() {
            if (gameState.currentPhase !== 'day' || gameState.currentPhase === 'ended') {
                return;
            }
            // å¦‚æœAIå‘è¨€åºåˆ—å°šæœªå¯åŠ¨ï¼Œæ ‡è®°æ­£åœ¨å‘è¨€ï¼Œä»¥é¿å…å¤šæ¬¡è°ƒç”¨
            if (!gameState.aiSpeaking) {
                gameState.aiSpeaking = true;
            }
            const aliveAiPlayers = gameState.players.filter(p => p.alive && p.type === 'ai');
            if (aliveAiPlayers.length === 0) {
                // æ— AIå­˜æ´»ï¼Œç›´æ¥è¿›å…¥æŠ•ç¥¨
                gameState.aiSpeaking = false;
                setTimeout(() => startVotePhase(), 1000);
                return;
            }
            const playersToSpeak = aliveAiPlayers.filter(p => !gameState.spokenPlayers.has(p.id));
            if (playersToSpeak.length === 0) {
                // æ‰€æœ‰AIå·²å‘è¨€ï¼Œç»“æŸå‘è¨€åºåˆ—ï¼Œè¿›å…¥æŠ•ç¥¨
                gameState.aiSpeaking = false;
                setTimeout(() => startVotePhase(), 1000);
                return;
            }
            // å½“å‰å‘è¨€è€…
            const speaker = playersToSpeak[0];
            const thinkingMsgId = showThinkingIndicator(speaker.name);
            try {
                const context = buildGameContext(speaker);
                const result = await queryQwenModel(context, speaker.role, 'day');
                const logElement = document.querySelector(`#log-${thinkingMsgId}`);
                if (logElement) {
                    let response = result.response || "AIæœªå“åº”";
                    // è¿‡æ»¤å¯èƒ½æš´éœ²èº«ä»½çš„è¯è¯­ï¼Œé¿å…AIè‡ªæ›å®¶é—¨
                    response = filterAiResponse(response);
                    logElement.innerHTML = `<strong>${speaker.name}:</strong> ${response}`;
                }
                gameState.spokenPlayers.add(speaker.id);
                // ä¸‹ä¸€åAIå»¶è¿Ÿ3~6ç§’å‘è¨€ï¼Œå‡ç¼“èŠ‚å¥
                setTimeout(() => {
                    aiPlayersSpeakSequence();
                }, 3000 + Math.random() * 3000);
            } catch (error) {
                console.error(`AIå‘è¨€é”™è¯¯ [${speaker.name}]:`, error);
                const logElement = document.querySelector(`#log-${thinkingMsgId}`);
                if (logElement) {
                    logElement.textContent = `${speaker.name}: å‘è¨€å¤±è´¥`;
                }
                gameState.spokenPlayers.add(speaker.id);
                setTimeout(() => {
                    aiPlayersSpeakSequence();
                }, 2000);
            }
        }

        // æ„å»ºæ¸¸æˆä¸Šä¸‹æ–‡
        function buildGameContext(player) {
            let context = `å½“å‰æ˜¯ç¬¬${gameState.currentRound}å¤©ï¼Œç™½å¤©è®¨è®ºé˜¶æ®µã€‚
å­˜æ´»ç©å®¶: `;
            gameState.players.filter(p => p.alive).forEach(p => {
                context += `${p.name}ã€`;
            });
            context += "\nè¿‘æœŸæ¸¸æˆäº‹ä»¶:\n";
            const recentLogs = gameState.gameLog.slice(-5).map(log => `${log.sender}: ${log.message}`);
            context += recentLogs.join("\n");
            return context;
        }

        // æ˜¾ç¤ºAIæ€è€ƒæŒ‡ç¤ºå™¨
        function showThinkingIndicator(playerName) {
            const logEntry = addLog(playerName, 'æ­£åœ¨æ€è€ƒ... <span class="loading"></span>', 'player');
            return logEntry.id;
        }

        // è¿‡æ»¤AIå›å¤ä¸­çš„è§’è‰²ä¿¡æ¯ï¼Œé¿å…AIè‡ªæŠ¥å®¶é—¨
        function filterAiResponse(text) {
            if (!text || typeof text !== 'string') return text;
            let filtered = text;
            // åˆ—å‡ºå¯èƒ½æš´éœ²èº«ä»½çš„å…³é”®è¯
            const keywords = ['é¢„è¨€å®¶', 'å¥³å·«', 'ç‹¼äºº', 'å¹³æ°‘', 'å¥½äºº', 'æ‘æ°‘'];
            keywords.forEach(keyword => {
                // å…¨å±€æ›¿æ¢å…³é”®è¯ï¼Œé˜²æ­¢æš´éœ²èº«ä»½
                const regex = new RegExp(keyword, 'g');
                filtered = filtered.replace(regex, 'æŸäºº');
            });
            return filtered;
        }

        // è°ƒç”¨åç«¯API
        async function queryQwenModel(prompt, role = "villager", phase = "day") {
            try {
                const response = await fetch(`${gameState.apiUrl}/api/query`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt: prompt,
                        role: role,
                        phase: phase
                    })
                });
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`APIé”™è¯¯: ${response.status} - ${errorText}`);
                }
                return await response.json();
            } catch (error) {
                console.error("APIè°ƒç”¨å¤±è´¥:", error);
                return {
                    response: "AIæš‚æ—¶æ— æ³•å“åº”",
                    status: "error"
                };
            }
        }

        // æŠ•ç¥¨é˜¶æ®µ
        function startVotePhase() {
            if (gameState.currentPhase === 'ended') return;
            clearAllTimers();
            gameState.currentPhase = 'vote';
            gameState.votes = {};
            updateGameStatus();
            updateButtons();

            addLog('æ³•å®˜', `ğŸ—³ï¸ æŠ•ç¥¨ç¯èŠ‚å¼€å§‹ã€‚å­˜æ´»ç©å®¶ï¼š${
                gameState.players.filter(p => p.alive).map(p => p.name).join(', ')
            }`, 'system');

            // å¡«å……æŠ•ç¥¨é€‰é¡¹
            const voteSelect = document.getElementById('vote-select');
            voteSelect.innerHTML = '<option value="">é€‰æ‹©è¦æŠ•ç¥¨çš„ç©å®¶</option>';
            gameState.players
                .filter(p => p.alive && p.id !== gameState.userPlayer.id)
                .forEach(player => {
                    const option = document.createElement('option');
                    option.value = player.id;
                    option.textContent = player.name;
                    voteSelect.appendChild(option);
                });

            // AIæŠ•ç¥¨
            setTimeout(() => {
                if (gameState.currentPhase === 'vote') {
                    aiPlayersVote();
                }
            }, 3000);

            // 20ç§’åå¤„ç†æŠ•ç¥¨ç»“æœ
            const timeoutId = setTimeout(() => {
                if (gameState.currentPhase === 'vote') {
                    addLog('æ³•å®˜', 'â° æŠ•ç¥¨æ—¶é—´åˆ°ï¼Œç»Ÿè®¡ç»“æœã€‚', 'system');
                    processVoteResult();
                }
            }, 20000);
            gameState.timers.push(timeoutId);
        }

        // AIæŠ•ç¥¨é€»è¾‘
        async function aiPlayersVote() {
            if (gameState.currentPhase !== 'vote') return;
            const aliveAiPlayers = gameState.players.filter(p => p.alive && p.type === 'ai');
            const alivePlayers = gameState.players.filter(p => p.alive);

            for (const voter of aliveAiPlayers) {
                // å€™é€‰äºº: æ‰€æœ‰å­˜æ´»ä¸”ä¸æ˜¯è‡ªå·±
                const candidates = alivePlayers.filter(p => p.id !== voter.id);
                if (candidates.length > 0) {
                    // æ ¹æ®å«Œç–‘å€¼é€‰æ‹©ç›®æ ‡
                    let maxSuspicion = -Infinity;
                    candidates.forEach(c => {
                        // é»˜è®¤å«Œç–‘å€¼ä¸º0
                        let sus = gameState.suspicion[c.id] || 0;
                        // ç‹¼äººæ›´å€¾å‘æŠ•ç¥¨å«Œç–‘å€¼ä½ï¼ˆä¿æŠ¤åŒä¼´ï¼‰ï¼›æ™®é€šç©å®¶æ›´å€¾å‘æŠ•ç¥¨å«Œç–‘å€¼é«˜
                        if (voter.role === 'werewolf') {
                            sus = -sus;
                        }
                        if (sus > maxSuspicion) maxSuspicion = sus;
                    });
                    // å¦‚æœå«Œç–‘å€¼å…¨ä¸º0ï¼Œåˆ™éšæœºé€‰æ‹©
                    let target;
                    if (maxSuspicion === 0) {
                        target = candidates[Math.floor(Math.random() * candidates.length)];
                    } else {
                        const topCandidates = candidates.filter(c => {
                            let sus = gameState.suspicion[c.id] || 0;
                            if (voter.role === 'werewolf') sus = -sus;
                            return sus >= maxSuspicion;
                        });
                        target = topCandidates[Math.floor(Math.random() * topCandidates.length)];
                    }
                    gameState.votes[voter.id] = target.id;
                    addLog('ç³»ç»Ÿ', `${voter.name} æŠ•ç¥¨ç»™ ${target.name}`, 'player');
                }
                // å»¶è¿Ÿä¸åŒAIæŠ•ç¥¨æ—¶é—´ï¼Œæ¨¡æ‹ŸçœŸå®æŠ•ç¥¨è¿‡ç¨‹
                await new Promise(resolve => setTimeout(resolve, 500 + Math.random() * 1000));
            }
        }

        // å¤„ç†æŠ•ç¥¨ç»“æœ
        function processVoteResult() {
            clearAllTimers();
            const voteCounts = {};
            Object.values(gameState.votes).forEach(targetId => {
                voteCounts[targetId] = (voteCounts[targetId] || 0) + 1;
            });

            let maxVotes = 0;
            let eliminatedPlayerIds = [];
            for (const [playerId, votes] of Object.entries(voteCounts)) {
                const id = parseInt(playerId);
                if (votes > maxVotes) {
                    maxVotes = votes;
                    eliminatedPlayerIds = [id];
                } else if (votes === maxVotes && votes > 0) {
                    eliminatedPlayerIds.push(id);
                }
            }

            let message = "";
            if (eliminatedPlayerIds.length === 0 || maxVotes === 0) {
                message = 'ğŸ“Š æœ¬è½®æ— äººæŠ•ç¥¨æˆ–å¹³ç¥¨ï¼Œæ— äººå‡ºå±€ã€‚';
            } else if (eliminatedPlayerIds.length === 1) {
                const eliminatedPlayer = gameState.players.find(p => p.id === eliminatedPlayerIds[0]);
                if (eliminatedPlayer) {
                    eliminatedPlayer.alive = false;
                    message = `ğŸ’€ æŠ•ç¥¨ç»“æŸï¼Œ${eliminatedPlayer.name}ï¼ˆ${getRoleName(eliminatedPlayer.role)}ï¼‰è¢«æŠ•ç¥¨å‡ºå±€ï¼`;
                }
            } else {
                const names = eliminatedPlayerIds.map(id => gameState.players.find(p => p.id === id)?.name).join(', ');
                message = `ğŸ“Š ${names} å¾—ç¥¨æ•°ç›¸åŒï¼Œå¹³ç¥¨æ— äººå‡ºå±€ã€‚`;
            }
            addLog('æ³•å®˜', message, 'system');
            renderPlayers();

            if (checkGameEnd()) {
                return;
            }

            gameState.currentRound++;
            setTimeout(() => {
                startNightPhase();
            }, 3000);
        }

        // æ£€æŸ¥æ¸¸æˆæ˜¯å¦ç»“æŸ
        function checkGameEnd() {
            const alivePlayers = gameState.players.filter(p => p.alive);
            const aliveWerewolves = alivePlayers.filter(p => p.role === 'werewolf');
            const aliveVillagers = alivePlayers.filter(p => p.role !== 'werewolf');

            if (aliveWerewolves.length === 0) {
                gameState.currentPhase = 'ended';
                addLog('æ³•å®˜', 'ğŸ‰ å¥½äººèƒœåˆ©ï¼æ‰€æœ‰ç‹¼äººéƒ½è¢«æ¶ˆç­äº†ï¼', 'system');
                updateGameStatus();
                updateButtons();
                clearAllTimers();
                return true;
            }
            if (aliveWerewolves.length >= aliveVillagers.length) {
                gameState.currentPhase = 'ended';
                addLog('æ³•å®˜', 'ğŸº ç‹¼äººèƒœåˆ©ï¼ç‹¼äººæ•°é‡å·²ç»è¾¾åˆ°æˆ–è¶…è¿‡å¥½äººï¼', 'system');
                updateGameStatus();
                updateButtons();
                clearAllTimers();
                return true;
            }
            return false;
        }

        // æ¸…é™¤æ‰€æœ‰å®šæ—¶å™¨
        function clearAllTimers() {
            gameState.timers.forEach(id => clearTimeout(id));
            gameState.timers = [];
        }

        // è¾…åŠ©å‡½æ•°
        function isUserWitch() {
            return gameState.userPlayer && gameState.userPlayer.alive && gameState.userPlayer.role === 'witch';
        }
        
        function isUserWerewolf() {
            return gameState.userPlayer && gameState.userPlayer.alive && gameState.userPlayer.role === 'werewolf';
        }
        
        function isUserSeer() {
            return gameState.userPlayer && gameState.userPlayer.alive && gameState.userPlayer.role === 'seer';
        }

        // ç”¨æˆ·è¡ŒåŠ¨å‡½æ•°
        function speak() {
            const input = document.getElementById('speak-input');
            const message = input.value.trim();
            if (message) {
                addLog(gameState.userPlayer.name, message, 'player');
                gameState.spokenPlayers.add(gameState.userPlayer.id);
                input.value = '';
                closeModal('speak-modal');
                
                if (gameState.currentPhase === 'day') {
                    const alivePlayers = gameState.players.filter(p => p.alive);
                    const allSpoken = alivePlayers.every(p => gameState.spokenPlayers.has(p.id));
                    if (allSpoken) {
                        addLog('æ³•å®˜', 'ğŸ“¢ æ‰€æœ‰ç©å®¶å‘è¨€å®Œæ¯•ï¼Œè¿›å…¥æŠ•ç¥¨é˜¶æ®µã€‚', 'system');
                        setTimeout(() => startVotePhase(), 1000);
                    }
                }
            }
        }

        function vote() {
            const select = document.getElementById('vote-select');
            const targetId = parseInt(select.value);
            if (!isNaN(targetId) && targetId >= 0) {
                const target = gameState.players.find(p => p.id === targetId);
                if (target) {
                    gameState.votes[gameState.userPlayer.id] = targetId;
                    addLog('ç³»ç»Ÿ', `ä½ æŠ•ç¥¨ç»™äº† ${target.name}`, 'system');
                    closeModal('vote-modal');
                    updateButtons();
                    
                    if (gameState.currentPhase === 'vote') {
                        const alivePlayers = gameState.players.filter(p => p.alive);
                        const votesCast = Object.keys(gameState.votes).length;
                        if (votesCast >= alivePlayers.length - 1) {
                            addLog('æ³•å®˜', 'ğŸ“¢ æ‰€æœ‰ç©å®¶æŠ•ç¥¨å®Œæ¯•ï¼Œç»Ÿè®¡ç»“æœã€‚', 'system');
                            setTimeout(() => processVoteResult(), 1000);
                        }
                    }
                }
            }
        }

        function kill() {
            const select = document.getElementById('kill-select');
            const targetId = parseInt(select.value);
            if (!isNaN(targetId) && targetId >= 0) {
                gameState.actions.userKillTarget = targetId;
                const target = gameState.players.find(p => p.id === targetId);
                // è®°å½•ç»™å¥³å·«å‚è€ƒï¼Œä¾¿äºå…¶æ•‘äºº
                gameState.witchState.lastKilledPlayerId = targetId;
                addLog('ç³»ç»Ÿ', `ä½ é€‰æ‹©å‡»æ€ ${target.name}`, 'werewolf');
                closeModal('kill-modal');
                updateButtons();
                checkAndProceedNight();
            }
        }

        function predict() {
            const select = document.getElementById('predict-select');
            const targetId = parseInt(select.value);
            if (!isNaN(targetId) && targetId >= 0) {
                gameState.actions.userSeerTarget = targetId;
                const target = gameState.players.find(p => p.id === targetId);
                const result = target.role === 'werewolf' ? 'ç‹¼äºº' : 'å¥½äºº';
                addLog('ç³»ç»Ÿ', `ä½ æŸ¥éªŒäº† ${target.name}ï¼Œç»“æœæ˜¯ï¼š${result}`, 'system');
                // è®°å½•é¢„è¨€å®¶è®°å¿†ï¼Œé¿å…è¿ç»­æŸ¥éªŒåŒä¸€äººï¼Œå¹¶æ›´æ–°å«Œç–‘å€¼ä¾›AIå‚è€ƒ
                if (!gameState.seerMemory.includes(targetId)) {
                    gameState.seerMemory.push(targetId);
                }
                if (gameState.suspicion[targetId] === undefined) gameState.suspicion[targetId] = 0;
                gameState.suspicion[targetId] += (result === 'ç‹¼äºº' ? 10 : -3);
                if (gameState.suspicion[targetId] < -10) gameState.suspicion[targetId] = -10;
                closeModal('predict-modal');
                updateButtons();
                checkAndProceedNight();
            }
        }

        // å¥³å·«æ•‘äººï¼ˆç°åœ¨æ˜¯ä¸‰é€‰ä¸€çš„ä¸€éƒ¨åˆ†ï¼‰
        function savePlayer() {
            // ç¡®å®šå½“å‰ç‹¼äººçš„å‡»æ€ç›®æ ‡ï¼ˆå¯èƒ½æ¥è‡ªç©å®¶æˆ–AIï¼‰
            const pendingKillId = gameState.actions.userKillTarget ?? gameState.actions.killTarget;
            if (pendingKillId !== undefined && pendingKillId !== null && !gameState.witchState.antidoteUsed) {
                const target = gameState.players.find(p => p.id === pendingKillId);
                if (target) {
                    gameState.actions.userWitchSave = pendingKillId;
                    gameState.witchState.antidoteUsed = true;
                    addLog('ç³»ç»Ÿ', `ä½ ä½¿ç”¨è§£è¯æ•‘äº† ${target.name}`, 'system');
                }
            }
            gameState.witchState.userActionCompleted = true;
            updateButtons();
            checkAndProceedNight();
        }

        // å¥³å·«æ¯’äºº
        function poison() {
            const select = document.getElementById('poison-select');
            const targetId = parseInt(select.value);
            if (!isNaN(targetId) && targetId >= 0 && !gameState.witchState.poisonUsed) {
                gameState.actions.userWitchPoison = targetId;
                const target = gameState.players.find(p => p.id === targetId);
                if (target) {
                    gameState.witchState.poisonUsed = true;
                    addLog('ç³»ç»Ÿ', `ä½ ä½¿ç”¨æ¯’è¯æ¯’æ­»äº† ${target.name}`, 'system');
                }
            }
            gameState.witchState.userActionCompleted = true;
            closeModal('poison-modal');
            updateButtons();
            checkAndProceedNight();
        }

        function skipPoison() {
            gameState.witchState.userActionCompleted = true;
            closeModal('poison-modal');
            updateButtons();
            checkAndProceedNight();
        }

        // å¥³å·«è·³è¿‡æ‰€æœ‰è¡ŒåŠ¨
        function skipWitchAction() {
            gameState.witchState.userActionCompleted = true;
            addLog('ç³»ç»Ÿ', 'ä½ é€‰æ‹©ä¸ä½¿ç”¨ä»»ä½•è¯æ°´', 'system');
            updateButtons();
            checkAndProceedNight();
        }

        // æµ‹è¯•APIè¿æ¥
        async function testApiConnection() {
            const testBtn = document.getElementById('api-test-btn');
            const originalText = testBtn.textContent;
            testBtn.disabled = true;
            testBtn.textContent = "æµ‹è¯•ä¸­...";
            try {
                const response = await queryQwenModel("ç®€å•å›å¤'ä½ å¥½'æ¥æµ‹è¯•è¿æ¥");
                if (response && response.response) {
                    alert(`APIè¿æ¥æˆåŠŸï¼æ¨¡å‹å›å¤: ${response.response}`);
                } else {
                    alert("APIè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥è®¾ç½®");
                }
            } catch (error) {
                alert("APIè¿æ¥å¤±è´¥: " + error.message);
            } finally {
                testBtn.disabled = false;
                testBtn.textContent = originalText;
            }
        }

        // UI ç›¸å…³å‡½æ•°
        function renderPlayers() {
            const grid = document.getElementById('players-grid');
            grid.innerHTML = '';
            gameState.players.forEach(player => {
                const card = document.createElement('div');
                card.className = `player-card ${player.type} ${!player.alive ? 'dead' : ''}`;
                let roleDisplay = '';
                if (player.type === 'user' || !player.alive) {
                    roleDisplay = getRoleName(player.role);
                } else {
                    roleDisplay = 'â“ æœªçŸ¥';
                }
                card.innerHTML = `
                    <div class="player-name">${player.name}</div>
                    <div class="player-role">${roleDisplay}</div>
                    <div class="player-status">${player.alive ? 'ğŸ’š å­˜æ´»' : 'ğŸ’€ å·²å‡ºå±€'}</div>
                `;
                grid.appendChild(card);
            });
        }

        function updateGameStatus() {
            const phaseElement = document.getElementById('game-phase');
            const roundElement = document.getElementById('game-round');
            const phaseNames = {
                'waiting': 'ğŸ® æ¸¸æˆå‡†å¤‡ä¸­',
                'night': 'ğŸŒ™ å¤œæ™šè¡ŒåŠ¨',
                'day': 'â˜€ï¸ ç™½å¤©è®¨è®º',
                'vote': 'ğŸ—³ï¸ æŠ•ç¥¨é˜¶æ®µ',
                'ended': 'ğŸ æ¸¸æˆç»“æŸ'
            };
            phaseElement.textContent = phaseNames[gameState.currentPhase] || 'æœªçŸ¥é˜¶æ®µ';
            roundElement.textContent = `ç¬¬ ${gameState.currentRound} å›åˆ`;
            
            document.querySelectorAll('.phase-step').forEach(step => {
                step.classList.remove('active');
            });
            if (gameState.currentPhase === 'day') {
                document.getElementById('phase-day').classList.add('active');
            } else if (gameState.currentPhase === 'night') {
                document.getElementById('phase-night').classList.add('active');
            } else if (gameState.currentPhase === 'vote') {
                document.getElementById('phase-vote').classList.add('active');
            }
        }

        function updateButtons() {
            const startBtn = document.getElementById('start-game');
            const speakBtn = document.getElementById('speak-btn');
            const voteBtn = document.getElementById('vote-btn');
            const killBtn = document.getElementById('kill-btn');
            // const protectBtn = document.getElementById('protect-btn'); // å·²ç§»é™¤å®ˆæŠ¤åŠŸèƒ½
            const predictBtn = document.getElementById('predict-btn');
            const saveBtn = document.getElementById('save-btn');
            const poisonBtn = document.getElementById('poison-btn');
            const skipWitchBtn = document.getElementById('skip-witch-btn');
            const actionStatus = document.getElementById('action-status');

            // é‡ç½®æ‰€æœ‰æŒ‰é’®
            // ç§»é™¤protectBtnåè°ƒæ•´æ•°ç»„
            [speakBtn, voteBtn, killBtn, predictBtn, saveBtn, poisonBtn, skipWitchBtn].forEach(btn => {
                btn.disabled = true;
            });

            if (!gameState.userPlayer || !gameState.userPlayer.alive) {
                actionStatus.textContent = 'ğŸ’€ ä½ å·²å‡ºå±€ï¼Œæ— æ³•è¡ŒåŠ¨ã€‚';
                startBtn.disabled = true;
                return;
            }
            
            if (gameState.currentPhase === 'waiting') {
                startBtn.disabled = false;
                actionStatus.textContent = 'ç­‰å¾…æ¸¸æˆå¼€å§‹...';
            } else if (gameState.currentPhase === 'day') {
                speakBtn.disabled = false;
                actionStatus.textContent = 'ç™½å¤©è®¨è®ºé˜¶æ®µï¼Œä½ å¯ä»¥å‘è¨€ã€‚';
            } else if (gameState.currentPhase === 'vote') {
                voteBtn.disabled = false;
                actionStatus.textContent = 'æŠ•ç¥¨é˜¶æ®µï¼Œè¯·é€‰æ‹©è¦æŠ•ç¥¨çš„ç©å®¶ã€‚';
            } else if (gameState.currentPhase === 'night') {
                actionStatus.textContent = 'å¤œæ™šè¡ŒåŠ¨é˜¶æ®µï¼Œè¯·é€‰æ‹©ä½ çš„è¡ŒåŠ¨ã€‚';
                
                if (isUserWerewolf() && !gameState.actions.userKillTarget) {
                    killBtn.disabled = false;
                }
                
                if (isUserSeer() && !gameState.actions.userSeerTarget) {
                    predictBtn.disabled = false;
                }
                
                if (isUserWitch() && !gameState.witchState.userActionCompleted) {
                    // å¥³å·«å¯ä»¥é€‰æ‹©æ•‘äººã€æ¯’äººæˆ–è·³è¿‡
                    skipWitchBtn.disabled = false;

                    // å½“å‰ç‹¼äººçš„å‡»æ€ç›®æ ‡ï¼ˆç”¨æˆ·æˆ–AIï¼‰
                    const pendingKillId = gameState.actions.userKillTarget ?? gameState.actions.killTarget;

                    // å¦‚æœæœ‰å¾…å‡»æ€ç›®æ ‡ä¸”è§£è¯æœªç”¨ï¼Œå¯ä»¥æ•‘äºº
                    if (pendingKillId !== undefined && pendingKillId !== null && !gameState.witchState.antidoteUsed) {
                        saveBtn.disabled = false;
                    }
                    // å¦‚æœæ¯’è¯æœªç”¨ï¼Œå¯ä»¥æ¯’äºº
                    if (!gameState.witchState.poisonUsed) {
                        poisonBtn.disabled = false;
                    }
                }
            } else if (gameState.currentPhase === 'ended') {
                startBtn.disabled = false;
                actionStatus.textContent = 'æ¸¸æˆå·²ç»“æŸï¼Œç‚¹å‡»"å¼€å§‹æ¸¸æˆ"é‡æ–°å¼€å§‹ã€‚';
            }
        }

        // æ·»åŠ æ¸¸æˆæ—¥å¿—
        function addLog(sender, message, type = 'system') {
            const logEntry = {
                id: Date.now(),
                sender,
                message,
                timestamp: new Date().toLocaleTimeString(),
                type
            };
            gameState.gameLog.push(logEntry);
            const logElement = document.createElement('div');
            logElement.className = `log-entry ${type}`;
            logElement.id = `log-${logEntry.id}`;
            logElement.innerHTML = `<strong>${sender}:</strong> ${message}`;
            document.getElementById('game-log').appendChild(logElement);
            document.getElementById('game-log').scrollTop = document.getElementById('game-log').scrollHeight;
            return logEntry;
        }

        // æ‰“å¼€æ¨¡æ€æ¡†
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }

        // å…³é—­æ¨¡æ€æ¡†
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // ä¿å­˜APIè®¾ç½®
        function saveApiSettings() {
            const apiUrl = document.getElementById('api-url-input').value.trim();
            if (apiUrl) {
                gameState.apiUrl = apiUrl;
                addLog('ç³»ç»Ÿ', `APIåœ°å€å·²è®¾ç½®ä¸º: ${apiUrl}`, 'system');
                closeModal('api-settings-modal');
            }
        }

        // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬
        document.getElementById('start-game').addEventListener('click', startGame);
        document.getElementById('speak-btn').addEventListener('click', () => openModal('speak-modal'));
        document.getElementById('vote-btn').addEventListener('click', () => openModal('vote-modal'));
        document.getElementById('kill-btn').addEventListener('click', () => openModal('kill-modal'));
        // å®ˆæŠ¤æŒ‰é’®åŠå…¶äº‹ä»¶å·²ç§»é™¤
        document.getElementById('predict-btn').addEventListener('click', () => openModal('predict-modal'));
        document.getElementById('save-btn').addEventListener('click', savePlayer);
        document.getElementById('poison-btn').addEventListener('click', () => openModal('poison-modal'));
        document.getElementById('skip-witch-btn').addEventListener('click', skipWitchAction);
        document.getElementById('api-test-btn').addEventListener('click', testApiConnection);

        // é”®ç›˜äº‹ä»¶ç›‘å¬
        document.getElementById('speak-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                speak();
            }
        });

        // åˆå§‹åŒ–æ¸¸æˆ
        initGame();
    </script>
</body>
</html>